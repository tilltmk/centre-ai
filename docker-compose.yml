# Centre AI - MCP Server with Admin UI
# Docker Compose Configuration
# Port Range: 2068+ (chronologically assigned)
# Only MCP (2068) and Admin UI (2069) are exposed to localhost

version: '3.8'

services:
  # ========================================
  # MCP Server - Port 2068 (exposed to localhost)
  # ========================================
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: centre-ai-mcp
    restart: unless-stopped
    ports:
      - "127.0.0.1:8068:2068"  # Internal access only, proxy handles external
    environment:
      - MCP_PORT=2068
      - API_DOMAIN=localhost:2068
      - MCP_DOMAIN=localhost:2068
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-centre_ai}
      - POSTGRES_USER=${POSTGRES_USER:-centre_ai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-centre_ai_secure_password}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OLLAMA_BASE_URL=http://ollama:11434
      - SECRET_KEY=${SECRET_KEY}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - ./git_repos:/app/git_repos
      - ./import:/app/import
      - ./src:/app/src
    networks:
      - centre-internal
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2068/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # HTTP Transport Server - Port 2070 (exposed to localhost)
  # For OpenWebUI, MCPO, and other HTTP-based AI clients
  # ========================================
  mcp-http:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: centre-ai-http
    restart: unless-stopped
    ports:
      - "127.0.0.1:2070:2070"
    environment:
      - HTTP_PORT=2070
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-centre_ai}
      - POSTGRES_USER=${POSTGRES_USER:-centre_ai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-centre_ai_secure_password}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OLLAMA_BASE_URL=http://ollama:11434
      - SECRET_KEY=${SECRET_KEY}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - ./git_repos:/app/git_repos
      - ./import:/app/import
      - ./src:/app/src
    networks:
      - centre-internal
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy
    command: ["python", "-m", "mcp_server.http_server"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # SSE Transport Server - Port 2071 (exposed to localhost)
  # For Claude Desktop and other SSE-based clients
  # ========================================
  mcp-sse:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: centre-ai-sse
    restart: unless-stopped
    ports:
      - "127.0.0.1:2071:2071"
    environment:
      - SSE_PORT=2071
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-centre_ai}
      - POSTGRES_USER=${POSTGRES_USER:-centre_ai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-centre_ai_secure_password}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OLLAMA_BASE_URL=http://ollama:11434
      - SECRET_KEY=${SECRET_KEY}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - ./git_repos:/app/git_repos
      - ./import:/app/import
      - ./src:/app/src
    networks:
      - centre-internal
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy
    command: ["python", "-m", "mcp_server.sse_server"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2071/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # Streamable HTTP Server - Port 2072 (exposed to localhost)
  # For real-time streaming and progress tracking
  # ========================================
  mcp-stream:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: centre-ai-stream
    restart: unless-stopped
    ports:
      - "127.0.0.1:2072:2072"
    environment:
      - STREAM_PORT=2072
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-centre_ai}
      - POSTGRES_USER=${POSTGRES_USER:-centre_ai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-centre_ai_secure_password}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - OLLAMA_BASE_URL=http://ollama:11434
      - SECRET_KEY=${SECRET_KEY}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - ./git_repos:/app/git_repos
      - ./import:/app/import
      - ./src:/app/src
    networks:
      - centre-internal
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy
    command: ["python", "-m", "mcp_server.streamable_server"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2072/stream/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # Reverse Proxy for External Access on Port 2068
  # ========================================
  proxy:
    image: nginx:alpine
    container_name: centre-ai-proxy
    restart: unless-stopped
    ports:
      - "2068:2068"
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - centre-internal
    depends_on:
      - mcp-server
      - mcp-sse
      - admin-ui

  # ========================================
  # Admin Web UI - Port 2069 (exposed to localhost)
  # ========================================
  admin-ui:
    build:
      context: .
      dockerfile: Dockerfile.admin
    container_name: centre-ai-admin
    restart: unless-stopped
    ports:
      - "127.0.0.1:2069:2069"
    environment:
      - ADMIN_PORT=2069
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-centre_ai}
      - POSTGRES_USER=${POSTGRES_USER:-centre_ai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-centre_ai_secure_password}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - SECRET_KEY=${SECRET_KEY}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - MCP_PORT=2068
    volumes:
      - ./data:/app/data
      - ./git_repos:/app/git_repos
      - ./import:/app/import
      - ./src:/app/src
    networks:
      - centre-internal
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2069/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ========================================
  # PostgreSQL Database - INTERNAL ONLY
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: centre-ai-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-centre_ai}
      - POSTGRES_USER=${POSTGRES_USER:-centre_ai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-centre_ai_secure_password}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - centre-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-centre_ai} -d ${POSTGRES_DB:-centre_ai}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ========================================
  # Qdrant Vector Database - INTERNAL ONLY
  # ========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: centre-ai-qdrant
    restart: unless-stopped
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - centre-internal
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:6333/collections || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ========================================
  # Redis Cache/Sessions - INTERNAL ONLY
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: centre-ai-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - centre-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # ========================================
  # Ollama AI Model Server - INTERNAL ONLY
  # ========================================
  ollama:
    image: ollama/ollama:latest
    container_name: centre-ai-ollama
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=0.0.0.0
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - centre-internal
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:11434/api/tags || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ========================================
  # JupyterLab - Port 2078 (exposed to localhost)
  # ========================================
  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: centre-ai-jupyter
    restart: unless-stopped
    ports:
      - "127.0.0.1:2078:8888"
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-centre_ai_jupyter}
      - NB_USER=jovyan
      - CHOWN_HOME=yes
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/data:ro
      - ./git_repos:/home/jovyan/git_repos:ro
    networks:
      - centre-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/api"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ========================================
# Internal Network (isolated communication)
# ========================================
networks:
  centre-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ========================================
# Persistent Volumes
# ========================================
volumes:
  postgres-data:
    driver: local
  qdrant-data:
    driver: local
  redis-data:
    driver: local
  ollama-data:
    driver: local
